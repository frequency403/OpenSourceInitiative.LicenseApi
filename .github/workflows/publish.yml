name: Publish NuGet

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"

permissions:
  contents: write

jobs:
  pack-and-publish:
    name: Pack & Publish (tag)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout tag
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Resolve version from tag + ensure tag is on main
        id: gate
        shell: bash
        run: |
          set -euo pipefail

          TAG="${GITHUB_REF_NAME}"     # vM.m.P
          VERSION="${TAG#v}"           # M.m.P

          if [[ ! "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Tag '$TAG' is not SemVer (vM.m.P)."
            exit 1
          fi

          # Ensure the tagged commit is reachable from main
          git fetch origin main --tags --force
          if ! git branch -r --contains HEAD | grep -qE 'origin/main$'; then
            echo "Tagged commit is not contained in origin/main; refusing to publish."
            exit 1
          fi

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "10.0.x"

      - name: Restore
        run: dotnet restore

      - name: Build
        run: dotnet build -c Release --no-restore

      - name: Pack Core package
        run: >-
          dotnet pack OpenSourceInitiative.LicenseApi/OpenSourceInitiative.LicenseApi.csproj
          -c Release -o ./nupkg
          --no-build
          -p:PackageVersion=${{ steps.gate.outputs.version }}
          -p:ContinuousIntegrationBuild=true

      - name: Publish to NuGet.org
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
        run: >-
          dotnet nuget push "./nupkg/*.nupkg"
          --api-key "$NUGET_API_KEY"
          --source https://api.nuget.org/v3/index.json
          --skip-duplicate

      - name: Create GitHub Release and upload packages
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.gate.outputs.tag }}
          name: ${{ steps.gate.outputs.tag }}
          prerelease: false
          generate_release_notes: true
          files: |
            nupkg/*.nupkg