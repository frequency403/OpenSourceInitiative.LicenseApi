name: Publish NuGet

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

permissions:
  contents: write

jobs:
  pack-and-publish:
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'push' &&
      startsWith(github.event.workflow_run.head_branch, 'v')
    runs-on: ubuntu-latest
    steps:
      - name: Validate version tag format
        shell: bash
        run: |
          REF="${{ github.event.workflow_run.head_branch }}"
          if [[ ! "$REF" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-beta\.[0-9]+)?$ ]]; then
            echo "Branch '$REF' does not match version tag pattern (vX.Y.Z or vX.Y.Z-beta.N)"
            exit 1
          fi
          echo "Valid version tag: $REF"

      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '10.0.x'

      - name: Determine version from tag
        shell: bash
        run: |
          REF="${{ github.event.workflow_run.head_branch }}"
          VERSION="${REF#v}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Determined version: $VERSION"

      - name: Validate SemVer (allow -beta.N)
        shell: bash
        run: |
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-beta\.[0-9]+)?$ ]]; then
            echo "Tag '$VERSION' is not a valid SemVer (allowing -beta.N)."
            exit 1
          fi

      - name: Restore
        run: dotnet restore

      - name: Build
        run: dotnet build -c Release --no-restore

      - name: Pack Core package
        run: >-
          dotnet pack OpenSourceInitiative.LicenseApi/OpenSourceInitiative.LicenseApi.csproj
          -c Release -o ./nupkg
          --no-build
          -p:PackageVersion=${{ env.VERSION }}
          -p:ContinuousIntegrationBuild=true

      - name: Pack DI package
        run: >-
          dotnet pack OpenSourceInitiative.LicenseApi.DependencyInjection/OpenSourceInitiative.LicenseApi.DependencyInjection.csproj
          -c Release -o ./nupkg
          --no-build
          -p:PackageVersion=${{ env.VERSION }}
          -p:ContinuousIntegrationBuild=true

      - name: Publish to NuGet.org
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
        run: >-
          dotnet nuget push "./nupkg/*.nupkg"
          --api-key "$NUGET_API_KEY"
          --source https://api.nuget.org/v3/index.json
          --skip-duplicate

      - name: Create GitHub Release and upload packages
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          prerelease: ${{ contains(env.VERSION, '-beta.') }}
          generate_release_notes: true
          files: |
            nupkg/*.nupkg
